Format: Fall24-October10
Language: ru
Title: Исправляем медленную работу HDD в Windows 10
Slug: fixing-slow-hdd-windows-10
Categories: techie,tutorials
<p>Данная заметка посвящается всем, не сдающим позиции, пользователям жестких дисков.</p>
<p><a href="https://commons.wikimedia.org/wiki/File:Foodiesfeed.com_pouring-honey-on-pancakes-with-walnuts.jpg" target="_blank" rel="noopener noreferrer"><img loading="lazy" decoding="async" class="alignnone size-full wp-image-2597" src="https://demensdeum.com/blog/wp-content/uploads/2020/04/pancakes.jpg" alt="" width="256" height="320" srcset="https://demensdeum.com/blog/wp-content/uploads/2020/04/pancakes.jpg 256w, https://demensdeum.com/blog/wp-content/uploads/2020/04/pancakes-240x300.jpg 240w" sizes="auto, (max-width: 256px) 100vw, 256px" /></a><br />
<a href="https://commons.wikimedia.org/wiki/File:Foodiesfeed.com_pouring-honey-on-pancakes-with-walnuts.jpg" target="_blank" rel="noopener noreferrer">Original (Mae Mu)</a></p>
<p>Через 1.5 года использования ноутбука HP Pavilion в дуалбуте HDD (Windows 10) и SSD (Ubuntu) я стал замечать очень долгую загрузку приложений, общую неотзывчивость интерфейса, зависания на простейших операциях в Windows 10. Проблема была минимизирована до той степени, что пользоваться ноутбуком стало возможно снова. Далее опишу действия которые я предпринял для устранения проблемы.</p>
<h3>Диагностика</h3>
<p>Для начала исследования нужно устранить мистификацию любого порядка, для начала определим основные причины поломок жестких дисков. Что может пойти не так при работе с жестким диском? Проблемы могут возникать на физическом уровне электроники и на логическом, программном уровне данных.<br />
К проблемам электроники относятся такие вещи как: нерабочий блок питания компьютера/ноутбука, проблемы с аккумулятором ноутбука; износ компонентов жесткого диска, неполадки в схемах и чипах внутренних компонентов диска, программные ошибки прошивки, последствия ударов/падений диска, либо аналогичные проблемы с другими устройствами которые влияют на его работу.<br />
Критическим износом жесткого диска считается момент появления количества такого количества сбойных секторов (bad block) при котором дальнейшая эксплуатация диска невозможна. Данные блоки блокируются прошивкой жесткого диска, данные переносятся на другие сектора автоматически и не должны влиять на работу диска до определенного критического момента.<br />
К проблемам программной логики относятся ошибки в файловой системе из-за некорректной работы приложений, действий пользователя: отключение устройства по горячему, завершение процессов записи без корректной остановки приложений, ошибки в драйверах, сервисах операционной системы.<br />
Не имея специализированных средств диагностики электроники, нам остается только проверять корректность программного уровня, уже в процессе могут обнаружиться неполадки электроники, которые обычно устраняют методом блочного ремонта (замена компонентов/чипов); Далее рассмотрим методы программной диагностики с помощью диагностических утилит. Стоит заметить что все утилиты должны запускаться на системе с максимальным приоритетом, т.к. другие приложения могут помешать замерам производительности, блокировать диск на чтение/запись, что приведет к некорректным результатам диагностики.</p>
<h4>SMART</h4>
<p><a href="https://en.wikipedia.org/wiki/S.M.A.R.T." target="_blank" rel="noopener noreferrer">S.M.A.R.T.</a> система мониторинга состояния устройств хранения данных &#8211; HDD, SDD, eMMC и пр. Позволяет оценить износ устройства, просматривать количество сбойных блоков (bad block), опираясь на данные предпринять дальнейшие действия. Просматривать SMART можно в разных приложениях для работы с дисками, я предпочитаю использовать утилиты от производителя. Для своего жесткого диска Seagate я использовал утилиту SeaTools, для него состояние выводилось как GOOD, то есть прошивка диска считает что все хорошо.</p>
<h4>Утилиты производителя</h4>
<p>Утилиты производителя диска предоставляют тесты для проверки его работы. SeaTools имеет несколько видов тестов, можно использовать их все для локализации проблемы. Быстрые и простые тесты могут не выявить каких-либо проблем, поэтому предпочитайте долгие тесты. В моем случае только на Long Test были найдены ошибки.</p>
<h4>Slowride</h4>
<p>Для проверки корректности чтения, нахождения медленных или мертвых блоков, я написал приложение <a href="https://gitlab.com/demensdeum/slowride/" target="_blank" rel="noopener noreferrer">slowride</a>, оно работает по очень простому принципу &#8211; открывает дескриптор блочного устройства, с заданными настройками пользователя производит чтения данных всего устройства, с замерами времени, выводом медленных блоков. Программа останавливается на первой же ошибке, в таком случае придется перейти к более серьезным утилитам для снятия данных, так как простыми методами данные диска прочитать не представляется возможным.<br />
В моем случае чтение всего диска осуществлялось корректно, с небольшой просадкой по скорости &#8211; 90мб/сек (5400rpm) за одну секунду, на некоторых областях диска. Из чего можно было сделать вывод что я имею дело с программной проблемой.</p>
<h4>Акустический анализ</h4>
<p>Данный метод не относится к программным методам диагностики, однако является достаточно важным для устранения проблемы. Например при частично рабочем блоке питания, жесткий диск может подвисать/зависать издавая громкий щелчок.<br />
В моем случае при работе с диском в Windows 10 я слышал знакомый всем владельцам HDD, <a href="https://www.youtube.com/watch?v=J09pWNQPK7U" target="_blank" rel="noopener noreferrer">громкий треск</a> бегающей туда-сюда головки диска при попытке сделать что-либо в операционной системе, однако звук был почти постоянным, это навело меня на мысль о слишком большой фрагментации диска, перегрузе диска фоновыми сервисами.</p>
<h3>Исправляем</h3>
<p>Проблемы электроники во время программной диагностики обнаружены не были, поблочное чтение всего диска завершалось корректно, однако SeaTools показал ошибки на проверке Long Test.</p>
<h4>Утилиты производителя</h4>
<p>Софт производителя диска помимо диагностики предоставляет процедуры исправления ошибок. В SeaTools за это отвечает кнопка Fix All, после подтверждения согласия с потенциальной потерей данных, запустится процесс исправления. Помог ли в моем случае этот фикс? Нет, диск продолжил работать также громко и медленно, однако ошибок Long Test больше не показывал.</p>
<h4>CHKDSK</h4>
<p>CHKSDK это утилита компании Microsoft для устранения программных ошибок для файловых систем Windows. Со временем такие ошибки накапливаются на диске и могут очень сильно мешать работе, в том числе приводить к невозможности читать/писать какие-либо данные вообще. Инструкцию по использованию утилиты вы можете найти на сайте Microsoft, я же порекомендую использовать все возможные флаги для исправления ошибок (на момент написания заметки это /r /b /f); Запускать проверку нужно с правами администратора через терминал Windows (cmd), для системного раздела она будет проходить на загрузке системы, может проходить очень долгое время, в моем случае заняло 12 часов.<br />
Помог ли этот фикс в моем случае? Нет.</p>
<h4>Дефрагментация диска</h4>
<p>Работа с данными на диске осуществляется блоками, большие файлы обычно записываются в несколько блоков/фрагментов. Со временем, множество удаленных файлов создают пустые блоки которые не находятся рядом, из-за этого при записи файлы заполняют эти пустоты, и головке диска приходится физически преодолевать большие расстояния. Данная проблема называется фрагментацией, и с ней сталкиваются только пользователи жестких дисков. На момент нескольких фиксов фрагментация моего жесткого диска составляла 41%, визуально это выглядело так:</p>
<p><img loading="lazy" decoding="async" class="alignnone size-full wp-image-2599" src="https://demensdeum.com/blog/wp-content/uploads/2020/04/red.jpg" alt="" width="320" height="43" srcset="https://demensdeum.com/blog/wp-content/uploads/2020/04/red.jpg 320w, https://demensdeum.com/blog/wp-content/uploads/2020/04/red-300x40.jpg 300w" sizes="auto, (max-width: 320px) 100vw, 320px" /></p>
<p>То есть все плохо. Увидеть фрагментацию, провести дефрагментацию можно с помощью утилиты Defragger, либо встроенным дефрагментатором. Также можно включить сервис &#8220;Optimize drives&#8221; в Windows 10, проставить дефрагментацию по расписанию в контрольной панели. <strong>Дефрагментацию нужна только HDD дискам, включать для SSD дисков нежелательно</strong>, так как это приведет к ускоренному износу диска, видимо по этой причине фоновая дефрагментация отключена по умолчанию.</p>
<p>Известен также альтернативный вариант дефрагментации &#8211; перенос данных на другой диск, форматирование диска, и копирование данных обратно. В таком случае данные будут записаны на абсолютно пустые сектора, с сохранением корректной логической структуры для работы системы. Данный вариант чреват проблемами сброса потенциально критических метаданных, которые могут не переместиться при обычном копировании.</p>
<h4>Отключаем сервисы</h4>
<p>С помощью утилиты Марка Руссиновича <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon" target="_blank" rel="noopener noreferrer">Process Monitor</a> можно отследить процессы которые загружают жесткий диск своими делами, достаточно включить колонки IO Write/Read. После исследования данной колонки я отключил сервис Xbox Game Bar, известный сервис фонового ускорения программ Superfetch под новым названием SysMain, через панель сервисов контрольной панели. Superfetch должен постоянно анализировать приложения которыми пользуется юзер и ускорять их запуск с помощью кэширования в оперативную память, в моем случае это приводило к фоновой загрузке всего диска и невозможности работы.</p>
<h4>Чистим диск</h4>
<p>Также я удалил старые приложения, ненужные файлы, таким образом освободив сектора для корректной фрагментации, упростив работу операционной системе, уменьшив количество бесполезных, тяжелых сервисов и программ.</p>
<h3>Итог</h3>
<p>Что помогло больше всего? Заметная разница в производительности была достигнута после дефрагментации диска, спонтанные зависания удалось устранить с помощью отключения сервисов Xbox и Superfetch. Не было бы этих проблем, если бы я пользовался SSD? Проблем с медленной работой при фрагментацией определенно не было бы, проблемы с сервисами устранять пришлось бы в любом случае, а программные ошибки не зависят от типа накопителя. В ближайшем будущем планирую полный переход на SSD, ну а пока &#8220;Да здравствуют блины, блины навсегда!&#8221;</p>
<h3>Ссылки</h3>
<p><a href="http://www.outsidethebox.ms/why-windows-8-defragments-your-ssd-and-how-you-can-avoid-this/" target="_blank" rel="noopener noreferrer">http://www.outsidethebox.ms/why-windows-8-defragments-your-ssd-and-how-you-can-avoid-this/</a><br />
<a href="https://channel9.msdn.com/Shows/The-Defrag-Show" target="_blank" rel="noopener noreferrer">https://channel9.msdn.com/Shows/The-Defrag-Show</a><br />
<a href="https://www.seagate.com/ru/ru/support/downloads/seatools/" target="_blank" rel="noopener noreferrer">https://www.seagate.com/ru/ru/support/downloads/seatools/</a><br />
<a href="https://www.ccleaner.com/defraggler/download" target="_blank" rel="noopener noreferrer">https://www.ccleaner.com/defraggler/download</a><br />
<a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/chkdsk" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/chkdsk</a><br />
<a href="https://gitlab.com/demensdeum/slowride/" target="_blank" rel="noopener noreferrer">https://gitlab.com/demensdeum/slowride/</a></p>